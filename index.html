<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æœˆåº¦æ”¶æ”¯åˆ†é… Â· å‚¨è“„12ä¸‡ç‰ˆï¼ˆPWA Â· è®°è´¦ä¸ä¿å­˜ï¼‰</title>
  <meta name="theme-color" content="#3b82f6" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #222;
      --muted: #666;
      --accent: #3b82f6;
      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --line: #e8e8ef;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", "PingFang SC", "Hiragino Sans", "Microsoft YaHei", sans-serif;
      background: var(--bg); color: var(--ink);
    }
    .wrap { max-width: 1040px; margin: 0 auto; }
    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.05);
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--line);
    }
    h1 { font-size: 22px; margin: 0 0 6px; }
    h2 { font-size: 18px; margin: 0 0 10px; }
    .sub { color: var(--muted); font-size: 14px; margin-bottom: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid var(--line); }
    th { background: #fafafa; font-weight: 600; }
    tfoot td { font-weight: 700; }
    .grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-top: 10px;}
    .kpi { background: var(--card); border:1px solid var(--line); border-radius: 12px; padding: 14px; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .val { font-size: 20px; font-weight: 800; margin-top: 4px; }
    .badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#eef2ff; border:1px solid #e5e7eb; color:#374151; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items: center; }
    input, select, button, textarea { padding:12px; border-radius:12px; border:1px solid var(--line); background:#fff; font-size:16px; }
    button { cursor:pointer; }
    .btn { background: var(--accent); color:#fff; border: none; }
    .btn-text { background:transparent; color:var(--accent); border:1px solid var(--accent); }
    .btn-danger { background: var(--danger); color:#fff; border:none; }
    .muted { color: var(--muted); }
    .bar-wrap { width:100%; background:#f2f3f8; border-radius:999px; height:10px; overflow:hidden; border:1px solid var(--line);}
    .bar { height:100%; background: linear-gradient(90deg, #60a5fa, #10b981); width:0%; }
    .bar.warn { background: linear-gradient(90deg, #fbbf24, #f97316); }
    .bar.danger { background: linear-gradient(90deg, #f87171, #ef4444); }
    .right { text-align:right; }
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .note { background:#fffbeb; border:1px dashed #f59e0b; color:#7c5e10; padding:10px 12px; border-radius:12px; font-size:13px; }
    .small { font-size: 12px; }
    .nowrap { white-space: nowrap; }

    /* Mobile tweaks */
    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
      .two-col { grid-template-columns: 1fr; }
      .wrap { padding-bottom: 80px; } /* space for fab */
    }
    .fab {
      position: fixed;
      right: 16px; bottom: 16px;
      background: var(--accent);
      color: #fff; border: none; border-radius: 999px;
      padding: 12px 16px; font-size: 14px; box-shadow: 0 10px 18px rgba(0,0,0,.15);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ“ æœˆåº¦æ”¶æ”¯åˆ†é…ï¼ˆå‚¨è“„ 12 ä¸‡ / æœˆï¼‰</h1>
      <p class="sub">ä¿é™º ï¼“ä¸‡ + NISAè²¯é‡‘ï¼™ä¸‡ Â· æ‰‹æœºå¯å®‰è£… Â· ç¦»çº¿å¯ç”¨</p>
    </div>

    <div class="card">
      <div class="grid">
        <div class="kpi">
          <div class="label">æœˆåˆ°æ‰‹æ”¶å…¥</div>
          <div class="val">Â¥ 240,000</div>
          <div class="small">å•ä½ï¼šæ—¥å…ƒ</div>
        </div>
        <div class="kpi">
          <div class="label">æœˆåº¦å‚¨è“„ï¼ˆè‡ªåŠ¨ï¼‰</div>
          <div class="val ok">Â¥ 120,000</div>
          <div class="small">å‘è–ªæ—¥è‡ªåŠ¨è½¬å…¥å‚¨è“„è´¦æˆ·</div>
        </div>
        <div class="kpi">
          <div class="label">å‰©ä½™å¯æ”¯é…</div>
          <div class="val">Â¥ 50,000</div>
          <div class="small">æ‰£é™¤å‚¨è“„ä¸å›ºå®šæ”¯å‡ºå</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>â‘  æœˆåº¦é¢„ç®—æ˜ç»†</h2>
      <table>
        <thead>
          <tr>
            <th>ç”¨é€”</th>
            <th>é‡‘é¢ï¼ˆÂ¥ï¼‰</th>
            <th>è¯´æ˜</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>åˆ°æ‰‹æ”¶å…¥</td>
            <td>240,000</td>
            <td>æ¯æœˆå·¥èµ„åˆ°è´¦</td>
          </tr>
          <tr>
            <td>å‚¨è“„ä¸“ç”¨è´¦æˆ· <span class="badge">è‡ªåŠ¨è½¬è´¦</span></td>
            <td>-120,000</td>
            <td>å‘è–ªæ—¥å›ºå®šè½¬å¸³</td>
          </tr>
          <tr>
            <td>å®¶è³ƒé›»åŠ›ç‡ƒè²»ç­‰</td>
            <td>-70,000</td>
            <td>å›ºå®šæ”¯å‡º</td>
          </tr>
          <tr>
            <td>é£Ÿè²»</td>
            <td>-30,000</td>
            <td>æ¯æ—¥ä¸‰é¤Â¥1000ï¼ˆå®¶åº­å•ä½Â¥2000ï¼‰</td>
          </tr>
          <tr>
            <td>å¨±ä¹æ´»åŠ¨</td>
            <td>-10,000</td>
            <td>æ¯é€±1æ¬¡ï¼Œæ¯æ¬¡Â¥2500ä»¥å†…</td>
          </tr>
          <tr>
            <td>äº¤é€šè²»</td>
            <td>-10,000</td>
            <td>å‘è–ªæ—¥æ‰‹åŠ¨å……å€¼</td>
          </tr>
        </tbody>
      </table>
      <p class="note">è¯´æ˜ï¼šå¯æ”¯é…é‡‘é¢åˆè®¡ä¸º 5 ä¸‡ï¼ˆé£Ÿè²»3ä¸‡ + å¨±ä¹æ´»åŠ¨1ä¸‡ + äº¤é€šè²»1ä¸‡ï¼‰ã€‚</p>
    </div>

    <div class="card">
      <h2>â‘¡ æœ¬æœˆé¢„ç®—ä¸è¿›åº¦</h2>
      <div class="row" style="gap:8px; align-items:center;">
        <label for="monthPick" class="nowrap">é€‰æ‹©æœˆä»½ï¼š</label>
        <input id="monthPick" type="month" />
        <button id="resetMonth" class="btn-text">åˆå§‹åŒ–/åˆ‡æ¢æœˆä»½</button>
        <span class="muted small">ï¼ˆæ¯ä¸ªæœˆåˆ†åˆ«ç‹¬ç«‹è®°è´¦ä¸é¢„ç®—ï¼‰</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>ç±»åˆ«</th>
            <th>é¢„ç®—ï¼ˆÂ¥ï¼‰</th>
            <th>å·²ç”¨ï¼ˆÂ¥ï¼‰</th>
            <th>å‰©ä½™ï¼ˆÂ¥ï¼‰</th>
            <th>è¿›åº¦</th>
          </tr>
        </thead>
        <tbody id="budgetRows"></tbody>
        <tfoot>
          <tr>
            <td><strong>åˆè®¡ï¼ˆå¯æ”¯é…ï¼‰</strong></td>
            <td class="right nowrap" id="sumBudget">â€”</td>
            <td class="right nowrap" id="sumSpent">â€”</td>
            <td class="right nowrap" id="sumRemain">â€”</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="card">
      <h2>â‘¢ è®°å¸³</h2>
      <div class="two-col">
        <div>
          <div class="row">
            <label class="nowrap">æ—¥æœŸ</label>
            <input id="date" type="date" />
          </div>
          <div class="row">
            <label class="nowrap">ç±»åˆ«</label>
            <select id="category">
              <option value="food">é£Ÿè²»</option>
              <option value="entertain">å¨±ä¹æ´»åŠ¨</option>
              <option value="transport">äº¤é€šè²»</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
          <div class="row">
            <label class="nowrap">é‡‘é¢ï¼ˆÂ¥ï¼‰</label>
            <input id="amount" type="number" inputmode="numeric" min="1" step="1" placeholder="1000" />
          </div>
          <div class="row">
            <label class="nowrap">å¤‡æ³¨</label>
            <input id="memo" type="text" placeholder="åº—å/ç”¨é€”ï¼ˆå¯ç©ºï¼‰" />
          </div>
          <div class="row">
            <button id="add" class="btn">æ·»åŠ è®°å½•</button>
          </div>
        </div>
        <div>
          <p class="note">æç¤ºï¼š<br>â€¢ æ¯æ—¥ä¸‰é¤Â¥1000ï¼ˆå®¶åº­å•ä½Â¥2000ï¼‰ï¼›<br>â€¢ å¨±ä¹æ´»åŠ¨æ¯é€±1æ¬¡ï¼Œæ¯æ¬¡Â¥2500ä»¥å†…ï¼›<br>â€¢ äº¤é€šè²»æ¯æœˆä¸Šé™Â¥10,000ã€‚</p>
          <div class="row">
            <button id="exportCsv" class="btn-text">å¯¼å‡ºå½“å‰æœˆä¸º CSV</button>
            <button id="clearMonth" class="btn-danger">æ¸…ç©ºå½“å‰æœˆè®°å½•</button>
          </div>
          <p class="small muted">æ•°æ®ä¿å­˜åœ¨ä½ çš„è®¾å¤‡ <strong>æœ¬åœ°</strong>ï¼ˆlocalStorageï¼‰ã€‚æ¢è®¾å¤‡/æµè§ˆå™¨ä¼šä¸¢å¤±ï¼Œè®°å¾—å¯¼å‡º CSV å¤‡ä»½ã€‚</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>â‘£ å½“æœˆè®°å½•</h2>
      <table>
        <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>ç±»åˆ«</th>
            <th class="right">é‡‘é¢ï¼ˆÂ¥ï¼‰</th>
            <th>å¤‡æ³¨</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="recordsBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="small muted">å°æŠ€å·§ï¼šä½¿ç”¨æµè§ˆå™¨æœç´¢ï¼ˆCtrl/Cmd + Fï¼‰å¿«é€Ÿç­›é€‰åº—åæˆ–é‡‘é¢ã€‚</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <button id="installBtn" class="fab" hidden>å®‰è£…åˆ°æ‰‹æœº</button>

  <script>
    // ===== PWA install prompt =====
    let deferredPrompt = null;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.hidden = false;
    });
    installBtn.addEventListener('click', async () => {
      installBtn.hidden = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      }
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const fmt = (n) => Number(n).toLocaleString('zh-CN');

    const CATEGORY_LABELS = {
      food: 'é£Ÿè²»',
      entertain: 'å¨±ä¹æ´»åŠ¨',
      transport: 'äº¤é€šè²»',
      other: 'å…¶ä»–',
    };
    const BUDGETS = { food: 30000, entertain: 10000, transport: 10000, other: 0 };
    const monthKey = (ym) => 'budgetApp::single::' + ym;

    function loadData(ym) {
      const s = localStorage.getItem(monthKey(ym));
      if (!s) return [];
      try { return JSON.parse(s); } catch (e) { return []; }
    }
    function saveData(ym, arr) { localStorage.setItem(monthKey(ym), JSON.stringify(arr)); }

    function renderBudget(ym) {
      const rowsEl = $('#budgetRows');
      rowsEl.innerHTML = '';
      const recs = loadData(ym);
      const spent = { food:0, entertain:0, transport:0, other:0 };
      recs.forEach(r => { spent[r.cat] = (spent[r.cat]||0) + Number(r.amount); });

      let sumBudget=0, sumSpent=0;
      Object.keys(BUDGETS).forEach(cat => {
        const b = BUDGETS[cat];
        const s = spent[cat] || 0;
        const remain = b - s;
        sumBudget += b;
        sumSpent += s;

        let pct = b > 0 ? Math.min(100, Math.round(s / b * 100)) : (s>0 ? 100 : 0);
        let cls = 'bar';
        if (b>0) {
          if (pct <= 70) cls = 'bar';
          else if (pct <= 100) cls = 'bar warn';
          else cls = 'bar danger';
        } else {
          if (s > 0) cls = 'bar danger';
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${CATEGORY_LABELS[cat]}</td>
          <td class="right nowrap">${fmt(b)}</td>
          <td class="right nowrap">${fmt(s)}</td>
          <td class="right nowrap">${fmt(remain)}</td>
          <td><div class="bar-wrap"><div class="${cls}" style="width:${pct}%"></div></div></td>
        `;
        rowsEl.appendChild(tr);
      });
      $('#sumBudget').textContent = fmt(sumBudget);
      $('#sumSpent').textContent = fmt(sumSpent);
      $('#sumRemain').textContent = fmt(sumBudget - sumSpent);
    }

    function renderRecords(ym) {
      const body = $('#recordsBody');
      body.innerHTML = '';
      const arr = loadData(ym);
      arr.sort((a,b) => a.date.localeCompare(b.date));
      arr.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${CATEGORY_LABELS[r.cat]||r.cat}</td>
          <td class="right">${fmt(r.amount)}</td>
          <td>${r.memo||''}</td>
          <td><button data-i="${idx}" class="btn-text btn-del">åˆ é™¤</button></td>
        `;
        body.appendChild(tr);
      });
      $$('.btn-del').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const i = Number(e.target.getAttribute('data-i'));
          const cur = loadData(ym);
          cur.splice(i,1);
          saveData(ym, cur);
          renderBudget(ym);
          renderRecords(ym);
        });
      });
    }

    function exportCSV() {
      const ym = $('#monthPick').value || new Date().toISOString().slice(0,7);
      const arr = loadData(ym);
      const header = ['æ—¥æœŸ','ç±»åˆ«','é‡‘é¢','å¤‡æ³¨'];
      const lines = [header.join(',')];
      arr.forEach(r => {
        const line = [
          r.date,
          CATEGORY_LABELS[r.cat]||r.cat,
          r.amount,
          (r.memo||'').replace(/,/g,'ï¼Œ')
        ].join(',');
        lines.push(line);
      });
      const blob = new Blob([lines.join('\\n')], {type: 'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `è®°è´¦_${ym}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    window.addEventListener('DOMContentLoaded', () => {
      const d = new Date();
      $('#monthPick').value = d.toISOString().slice(0,7);
      $('#date').value = d.toISOString().slice(0,10);

      $('#resetMonth').addEventListener('click', () => {
        renderBudget($('#monthPick').value);
        renderRecords($('#monthPick').value);
      });
      $('#exportCsv').addEventListener('click', exportCSV);

      $('#clearMonth').addEventListener('click', () => {
        const ym = $('#monthPick').value;
        if (confirm('ç¡®å®šè¦æ¸…ç©º '+ ym +' çš„æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
          localStorage.setItem(monthKey(ym), JSON.stringify([]));
          renderBudget(ym);
          renderRecords(ym);
        }
      });

      $('#add').addEventListener('click', () => {
        const ym = $('#monthPick').value;
        const date = $('#date').value;
        const cat = $('#category').value;
        const amount = Number($('#amount').value);
        const memo = $('#memo').value.trim();

        if (!date || !amount || amount <= 0) {
          alert('è¯·å¡«å†™æ­£ç¡®çš„æ—¥æœŸä¸é‡‘é¢'); return;
        }
        const arr = loadData(ym);
        arr.push({ date, cat, amount, memo });
        saveData(ym, arr);

        $('#amount').value = '';
        $('#memo').value = '';

        renderBudget(ym);
        renderRecords(ym);
      });

      const ym = $('#monthPick').value;
      renderBudget(ym);
      renderRecords(ym);
    });
  </script>
</body>
</html>
