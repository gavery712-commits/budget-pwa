<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ“ å®¶è¨ˆç°¿</title>
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --ink:#222; --muted:#666; --accent:#3b82f6; --line:#e8e8ef; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP","Hiragino Sans","Yu Gothic",sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1040px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.05)}
    h1{font-size:22px;margin:0 0 6px} h2{font-size:18px;margin:0 0 10px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px solid var(--line)} th{background:#fafafa;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:10px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .kpi .label{color:var(--muted);font-size:12px} .kpi .val{font-size:20px;font-weight:800;margin-top:4px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-size:16px}
    input[type="number"]{width:160px}
    input[type="text"]{width:160px}
    button{cursor:pointer}.btn{background:var(--accent);color:#fff;border:none}.btn-text{background:transparent;color:var(--accent);border:1px solid var(--accent)}.btn-danger{background:var(--danger);color:#fff;border:none}
    .bar-wrap{width:100%;background:#f2f3f8;border-radius:999px;height:10px;overflow:hidden;border:1px solid var(--line)}
    .bar{height:100%;background:linear-gradient(90deg,#60a5fa,#10b981);width:0%}.bar.warn{background:linear-gradient(90deg,#fbbf24,#f97316)}.bar.danger{background:linear-gradient(90deg,#f87171,#ef4444)}
    .right{text-align:right}.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}.small{font-size:12px}.muted{color:#666}.nowrap{white-space:nowrap}
    @media (max-width:720px){.grid{grid-template-columns:1fr}.two-col{grid-template-columns:1fr}.wrap{padding-bottom:80px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card"><h1>ğŸ“ å®¶è¨ˆç°¿</h1></div>

    <div class="card">
      <div class="grid">
        <div class="kpi">
          <div class="label">æœˆåï¼ˆæ‰‹å–ã‚Šï¼‰</div>
          <div class="val" id="kpiIncome">Â¥ 240,000</div>
          <div class="small">å˜ä½ï¼šå††</div>
        </div>
        <div class="kpi">
          <div class="label">æœˆæ¬¡è²¯è“„</div>
          <div class="val" id="kpiSaving">Â¥ 120,000</div>
          <div class="small">çµ¦ä¸æ—¥ã«è‡ªå‹•æŒ¯æ›¿</div>
        </div>
        <div class="kpi">
          <div class="label">æ®‹ã‚Šç”Ÿæ´»è²»</div>
          <div class="val" id="kpiDisposable">Â¥ 50,000</div>
          <div class="small">é£Ÿè²»ï¼‹å¨¯æ¥½ï¼‹äº¤é€šè²»</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>â‘  æœˆæ¬¡äºˆç®—æ˜ç´°ï¼ˆç·¨é›†å¯èƒ½ï¼‰</h2>
      <table>
        <thead>
          <tr>
            <th>ç”¨é€”</th>
            <th>é‡‘é¡ï¼ˆÂ¥ï¼‰</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>æœˆåï¼ˆæ‰‹å–ã‚Šï¼‰</td>
            <td><input id="p_income" type="number" min="0" step="1" value="240000" /></td>
          </tr>
          <tr>
            <td>æœˆæ¬¡è²¯è“„</td>
            <td><input id="p_saving" type="number" min="0" step="1" value="120000" /></td>
          </tr>
          <tr>
            <td>å®¶è³ƒãƒ»é›»æ°—ãƒ»ç‡ƒè²»ãªã©</td>
            <td><input id="p_fixed" type="number" min="0" step="1" value="70000" /></td
          </tr>
          <tr>
            <td>é£Ÿè²»</td>
            <td><input id="p_food" type="number" min="0" step="1" value="30000" /></td>
          </tr>
          <tr>
            <td>å¨¯æ¥½</td>
            <td><input id="p_fun" type="number" min="0" step="1" value="10000" /></td>
          </tr>
          <tr>
            <td>äº¤é€šè²»</td>
            <td><input id="p_transport" type="number" min="0" step="1" value="10000" /></td>
          </tr>
        </tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button id="savePlan" class="btn">ã“ã®äºˆç®—ã‚’ä¿å­˜</button>
        <span class="small muted">ï¼ˆä¿å­˜å…ˆï¼šã“ã®ç«¯æœ« / localStorageï¼‰</span>
      </div>
      <p class="small muted" id="planNote">ãƒã‚§ãƒƒã‚¯ï¼šé£Ÿè²»ï¼‹å¨¯æ¥½ï¼‹äº¤é€šè²» â‰¤ æ‰‹å–ã‚Š âˆ’ è²¯è“„ âˆ’ å›ºå®šè²»</p>
    </div>

    <div class="card">
      <h2>â‘¡ ä»Šæœˆã®äºˆç®—ã¨é€²æ—</h2>
      <div class="row" style="gap:8px">
        <label for="monthPick">æœˆï¼š</label>
        <input id="monthPick" type="month" />
        <button id="resetMonth" class="btn-text">ç¢ºèª</button>
      </div>
      <!-- æ‰‹å‹•å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼šã“ã®æœˆã®äºˆç®—ï¼ˆlocalStorageã«ä¿å­˜ï¼‰ -->
      <div class="row" style="margin-top:7px">
        <div>
          <label>é£Ÿè²»ï¼š    </label><input id="mb_food" type="number" min="0" step="1" value="30000">
        </div>
        <div>
          <label>å¨¯æ¥½ï¼š    </label><input id="mb_fun" type="number" min="0" step="1" value="10000">
        </div>
        <div>
          <label>äº¤é€šè²»ï¼š  </label><input id="mb_transport" type="number" min="0" step="1" value="10000">
        </div>
        <div>
          <label>ä¸Šè¨˜ä»¥å¤–ï¼š</label><input id="mb_other" type="number" min="0" step="1" value="0">
        </div>
          <button id="saveMonthBudget" class="btn">ã“ã®æœˆã®äºˆç®—ã‚’ä¿å­˜</button>
      </div>
      <table>
        <thead><tr><th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>äºˆç®—</th><th>ä½¿ç”¨æ¸ˆ</th><th>æ®‹ã‚Š</th><th>é€²æ—</th></tr></thead>
        <tbody id="budgetRows"></tbody>
        <tfoot><tr><td><strong>åˆè¨ˆ</strong></td><td class="right" id="sumBudget">â€”</td><td class="right" id="sumSpent">â€”</td><td class="right" id="sumRemain">â€”</td><td></td></tr></tfoot>
      </table>
    </div>

    <div class="card">
      <h2>â‘¢ è¨˜å¸³</h2>
      <div class="two-col">
        <div>
          <div class="row"><label>æ—¥ä»˜</label><input id="date" type="date"></div>
          <div class="row"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
            <select id="category">
              <option value="food">é£Ÿè²»</option>
              <option value="entertain">å¨¯æ¥½</option>
              <option value="transport">äº¤é€š</option>
              <option value="other">ä¸Šè¨˜ä»¥å¤–</option>
            </select>
          </div>
          <div class="row"><label>é‡‘é¡ï¼ˆÂ¥ï¼‰</label><input id="amount" type="number" min="1" step="1" placeholder="1000"></div>
          <div class="row"><label>ãƒ¡ãƒ¢</label><input id="memo" type="text" placeholder="ï¼ˆä»»æ„ï¼‰"></div>
          <div class="row"><button id="add" class="btn">è¿½åŠ </button></div>
        </div>
        <div>
          <p class="small muted">ãƒ’ãƒ³ãƒˆï¼š1æ—¥1000å††ç›®å®‰ï¼å¨¯æ¥½ã¯é€±1å›ãƒ»1å›2500å††ã¾ã§ï¼äº¤é€šè²»1ä¸‡å††ä¸Šé™</p>
          <div class="row"><button id="exportCsv" class="btn-text">CSV æ›¸ãå‡ºã—</button><button id="clearMonth" class="btn-danger">å½“æœˆã‚’å…¨å‰Šé™¤</button></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>â‘£ å½“æœˆã®è¨˜éŒ²</h2>
      <table>
        <thead><tr><th>æ—¥ä»˜</th><th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th class="right">é‡‘é¡ï¼ˆÂ¥ï¼‰</th><th>ãƒ¡ãƒ¢</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="recordsBody"></tbody>
      </table>
    </div>
  </div>

<script>
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
  const fmt = n=>Number(n).toLocaleString('ja-JP');

  // ===== â‘  äºˆç®—ãƒ—ãƒ©ãƒ³ï¼ˆKPIç”¨ï¼‰ =====
  const PLAN_KEY='budgetApp::plan::v1';
  const defaultPlan=()=>({income:240000,saving:120000,fixed:70000,food:30000,fun:10000,transport:10000});
  const loadPlan=()=>{ try{const s=localStorage.getItem(PLAN_KEY); return s?JSON.parse(s):defaultPlan();}catch{return defaultPlan();} };
  const savePlan=pl=>localStorage.setItem(PLAN_KEY, JSON.stringify(pl));

  const readPlan=()=>({ income:+$('#p_income').value||0, saving:+$('#p_saving').value||0, fixed:+$('#p_fixed').value||0, food:+$('#p_food').value||0, fun:+$('#p_fun').value||0, transport:+$('#p_transport').value||0 });
  const fillPlan=p=>{ $('#p_income').value=p.income; $('#p_saving').value=p.saving; $('#p_fixed').value=p.fixed; $('#p_food').value=p.food; $('#p_fun').value=p.fun; $('#p_transport').value=p.transport; };
  const validate=p=> (p.food+p.fun+p.transport) <= (p.income - p.saving - p.fixed);
  const syncKPIs=p=>{ $('#kpiIncome').textContent='Â¥ '+fmt(p.income); $('#kpiSaving').textContent='Â¥ '+fmt(p.saving); $('#kpiDisposable').textContent='Â¥ '+fmt(p.food+p.fun+p.transport); };

  // ===== â‘¡ æœˆåˆ¥äºˆç®—ï¼ˆæ‰‹å‹•å…¥åŠ›ãƒ»æœˆå˜ä½ã§ä¿å­˜ï¼‰ =====
  const monthBudgetKey=ym=>'budgetApp::monthBudget::'+ym;
  function loadMonthBudget(ym){
    try{ const s=localStorage.getItem(monthBudgetKey(ym)); if(s) return JSON.parse(s); }catch{}
    // ãªã„å ´åˆã¯ â‘  ã®å€¤ã‹ã‚‰åˆæœŸå€¤ã‚’ä½œã‚‹ï¼ˆä¿å­˜ã¯ã—ãªã„ï¼‰
    const pl = loadPlan(); return { food:pl.food, fun:pl.fun, transport:pl.transport, other:0 };
  }
  function saveMonthBudget(ym, mb){
    localStorage.setItem(monthBudgetKey(ym), JSON.stringify(mb));
  }
  function fillMonthBudgetInputs(mb){
    $('#mb_food').value = mb.food||0;
    $('#mb_fun').value = mb.fun||0;
    $('#mb_transport').value = mb.transport||0;
    $('#mb_other').value = mb.other||0;
  }
  function readMonthBudgetInputs(){
    return {
      food: +$('#mb_food').value||0,
      fun: +$('#mb_fun').value||0,
      transport: +$('#mb_transport').value||0,
      other: +$('#mb_other').value||0,
    };
  }

  // ===== è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ =====
  const CATEGORY_LABELS={food:'é£Ÿè²»',entertain:'å¨¯æ¥½',transport:'äº¤é€šè²»',other:'ãã®ä»–'};
  const monthKey=ym=>'budgetApp::single::'+ym;
  const loadData=ym=>{ const s=localStorage.getItem(monthKey(ym)); if(!s) return []; try{return JSON.parse(s);}catch{return [];} };
  const saveData=(ym,arr)=>localStorage.setItem(monthKey(ym), JSON.stringify(arr));

  function renderBudget(ym, mb){
    const rows=$('#budgetRows'); rows.innerHTML='';
    const recs=loadData(ym);
    const budgets={ food:mb.food||0, entertain:mb.fun||0, transport:mb.transport||0, other:mb.other||0 };
    const spent={ food:0, entertain:0, transport:0, other:0 };
    recs.forEach(r=>{ spent[r.cat]=(spent[r.cat]||0)+Number(r.amount); });

    let sumB=0,sumS=0;
    Object.keys(budgets).forEach(cat=>{
      const b=budgets[cat], s=spent[cat]||0, remain=b-s;
      sumB+=b; sumS+=s;
      const pct=b>0?Math.min(100,Math.round(s/b*100)):(s>0?100:0);
      let cls='bar'; if(b>0 && pct>70 && pct<=100) cls='bar warn'; else if(b>0 && pct>100) cls='bar danger';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${CATEGORY_LABELS[cat]}</td>
        <td class="right">${fmt(b)}</td><td class="right">${fmt(s)}</td><td class="right">${fmt(remain)}</td>
        <td><div class="bar-wrap"><div class="${cls}" style="width:${pct}%"></div></div></td>`;
      rows.appendChild(tr);
    });
    $('#sumBudget').textContent=fmt(sumB); $('#sumSpent').textContent=fmt(sumS); $('#sumRemain').textContent=fmt(sumB-sumS);
  }

  function renderRecords(ym){
    const body=$('#recordsBody'); body.innerHTML='';
    const arr=loadData(ym); arr.sort((a,b)=>a.date.localeCompare(b.date));
    arr.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.date}</td><td>${CATEGORY_LABELS[r.cat]||r.cat}</td><td class="right">${fmt(r.amount)}</td><td>${r.memo||''}</td><td><button data-i="${i}" class="btn-text btn-del">å‰Šé™¤</button></td>`;
      body.appendChild(tr);
    });
    $$('.btn-del').forEach(btn=>btn.addEventListener('click',e=>{
      const i=+e.target.getAttribute('data-i'); const ym=$('#monthPick').value;
      const cur=loadData(ym); cur.splice(i,1); saveData(ym,cur);
      const mb = loadMonthBudget(ym); renderBudget(ym, mb); renderRecords(ym);
    }));
  }

  function exportCSV(){
    const ym=$('#monthPick').value||new Date().toISOString().slice(0,7);
    const arr=loadData(ym); const lines=[['æ—¥ä»˜','ã‚«ãƒ†ã‚´ãƒªãƒ¼','é‡‘é¡','ãƒ¡ãƒ¢'].join(',')];
    arr.forEach(r=>lines.push([r.date,CATEGORY_LABELS[r.cat]||r.cat,r.amount,(r.memo||'').replace(/,/g,'ï¼Œ')].join(',')));
    const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`è¨˜å¸³_${ym}.csv`; a.click();
  }

  function renderAll(){
    const ym=$('#monthPick').value;
    const mb = loadMonthBudget(ym);
    fillMonthBudgetInputs(mb);
    renderBudget(ym, mb);
    renderRecords(ym);
    // KPI ã¯â‘ ã®ãƒ—ãƒ©ãƒ³ã‹ã‚‰
    const p = loadPlan(); syncKPIs(p);
  }

  window.addEventListener('DOMContentLoaded',()=>{
    const d=new Date(); $('#monthPick').value=d.toISOString().slice(0,7); $('#date').value=d.toISOString().slice(0,10);

    // â‘  åˆæœŸåŒ–
    const p=loadPlan(); fillPlan(p); syncKPIs(p);

    // â‘  ä¿å­˜
    $('#savePlan').addEventListener('click',()=>{
      const np=readPlan();
      const disposable=np.income-np.saving-np.fixed;
      const sum3=np.food+np.fun+np.transport;
      if(sum3>disposable){
        alert(`ä¿å­˜ã§ãã¾ã›ã‚“ï¼šé£Ÿè²»ï¼‹å¨¯æ¥½ï¼‹äº¤é€šè²»ï¼ˆÂ¥${fmt(sum3)}ï¼‰ãŒã€æ‰‹å–ã‚Šâˆ’è²¯è“„âˆ’å›ºå®šè²»ï¼ˆÂ¥${fmt(disposable)}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
        return;
      }
      savePlan(np);
      syncKPIs(np);
      const noteEl=$('#planNote'); if(noteEl){ noteEl.textContent='ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒã‚§ãƒƒã‚¯åˆæ ¼ï¼‰ã€‚'; setTimeout(()=>noteEl.textContent='ãƒã‚§ãƒƒã‚¯ï¼šé£Ÿè²»ï¼‹å¨¯æ¥½ï¼‹äº¤é€šè²» â‰¤ æ‰‹å–ã‚Š âˆ’ è²¯è“„ âˆ’ å›ºå®šè²»',2000); }
    });

    // â‘¡ æœˆåˆ‡ã‚Šæ›¿ãˆ
    $('#resetMonth').addEventListener('click', renderAll);

    // â‘¡ æœˆã®äºˆç®— ä¿å­˜
    $('#saveMonthBudget').addEventListener('click',()=>{
      const ym=$('#monthPick').value;
      const mb=readMonthBudgetInputs();
      saveMonthBudget(ym, mb);
      renderBudget(ym, mb);
    });

    // â‘¢ CSV / æ¶ˆå» / è¿½åŠ 
    $('#exportCsv').addEventListener('click', exportCSV);
    $('#clearMonth').addEventListener('click',()=>{
      const ym=$('#monthPick').value;
      if(confirm(`${ym} ã®è¨˜éŒ²ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)){ saveData(ym, []); renderAll(); }
    });
    $('#add').addEventListener('click',()=>{
      const ym=$('#monthPick').value; const date=$('#date').value; const cat=$('#category').value;
      const amount=+$('#amount').value; const memo=$('#memo').value.trim();
      if(!date || !amount || amount<=0){ alert('æ—¥ä»˜ã¨é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const arr=loadData(ym); arr.push({date,cat,amount,memo}); saveData(ym,arr);
      $('#amount').value=''; $('#memo').value=''; renderAll();
    });

    renderAll();
  });
</script>
</body>
</html>
